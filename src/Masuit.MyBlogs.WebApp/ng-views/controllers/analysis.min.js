myApp.controller("interview",["$scope","$http","NgTableParams","$timeout",function(n,t,i,r){var f,u,o,e;window.hub.disconnect();f=this;n.loading();n.distinct=!0;n.query="";n.currentPage=1;n.start=$.nowDate({DD:0}).substring(0,10);n.end=$.nowDate({DD:1});$("#start").val(n.start);$("#end").val(n.end);o={format:"YYYY-MM-DD hh:mm:ss",minDate:"2014-06-16 23:59:59",isinitVal:!0,maxDate:$.nowDate({DD:0}),choosefun:function(t,i){e.minDate=i;e.trigger=!1;$("#end").jeDate(e);n.start=i;$("#start").val(i)},okfun:function(t,i){e.minDate=i;e.trigger=!1;$("#end").jeDate(e);n.start=i;$("#start").val(i)}};e={format:"YYYY-MM-DD hh:mm:ss",minDate:$.nowDate({DD:0}),isinitVal:!0,maxDate:$.nowDate({DD:1}),choosefun:function(t,i){o.maxDate=i;n.end=i;$("#end").val(i)},okfun:function(t,i){o.maxDate=i;n.end=i;$("#end").val(i);f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage)}};$("#start").jeDate(o);$("#end").jeDate(e);$(".field").dropdown({allowAdditions:!1,onChange:function(t){["OperatingSystem","UserAgent","BrowserType","ISP","HttpMethod"].map(function(t){n[t]=!1});t.split(",").map(function(t){n[t]=!0});f.tableParams.reload()}});n.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:25,perPageOptions:[1,5,10,15,20,30,40,50],rememberPerPage:"perPageItems",onChange:function(){u&&r.cancel(u);u=r(function(){f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);u=null},100)}};n.search=function(){u&&r.cancel(u);u=r(function(){f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);u=null},1e3)};this.GetPageData=function(r,u){n.loading();t.post("/interview/getpage",{start:n.start,end:n.end,page:r,size:u,distinct:n.distinct,search:n.query}).then(function(t){t.data.Data?(n.paginationConf.currentPage=r,n.paginationConf.totalItems=t.data.TotalCount,$("#interview").next("div[ng-table-pagination]").remove(),f.tableParams=new i({count:5e4},{filterDelay:0,dataset:t.data.Data})):window.notie.alert({type:3,text:t.data.Message,time:4});n.loadingDone()})};n.loadingDone();n.doDistinct=function(){n.distinct=!n.distinct;u&&r.cancel(u);u=r(function(){f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);n.analysis();u=null},500)};n.analysis=function(){t.post("/interview/analysis",{uniq:n.distinct}).then(function(t){var i=t.data.Data,r,u,f,e;if(!t.data.Success){window.notie.alert({type:3,text:t.data.Message,time:4});return}n.interview=i;window.echarts.init(document.getElementById("map")).setOption({tooltip:{trigger:"item"},visualMap:{min:0,max:Enumerable.From(i.client).Where(n=>n.name!="XX").Max(n=>n.value),left:"left",top:"bottom",text:["高","低"],calculable:!0},series:[{name:"访问量",type:"map",mapType:"china",roam:!1,label:{normal:{show:!0},emphasis:{show:!0}},data:i.client}]});var y=["北京","天津","上海","重庆","河北","山西","辽宁","吉林","黑龙江","江苏","浙江","安徽","福建","江西","山东","河南","湖北","湖南","广东","海南","四川","贵州","云南","陕西","甘肃","青海","台湾","内蒙古","广西","西藏","宁夏","新疆","香港","澳门"],o=0,s=0,h={name:"中国",id:"中国",data:[]},c={name:"海外",id:"海外",data:[]};for(r=0;r<i.client.length;r++)y.indexOf(i.client[r].name)>=0?(o+=i.client[r].value,h.data.push([i.client[r].name,i.client[r].value])):(s+=i.client[r].value,c.data.push([i.client[r].name,i.client[r].value]));$("#client").highcharts({chart:{type:"pie",plotBackgroundColor:null,plotBorderWidth:null,backgroundColor:"transparent",plotShadow:!1},title:{text:"访问地区统计"},boost:{useGPUTranslations:!0},credits:{enabled:!1},plotOptions:{series:{dataLabels:{enabled:!0,format:"<b>{point.name}<\/b>: {point.percentage:.2f} % - {point.y}人/次"}}},tooltip:{headerFormat:"<span>{series.name}<\/span><br>",pointFormat:'<span style="color:{point.color}">{point.name}<\/span>: <b>{point.percentage:.2f}%<\/b> - {point.y}<\/b>人/次<br/>'},series:[{name:"访问地区统计",colorByPoint:!0,data:[{name:"中国",y:o,drilldown:"中国"},{name:"海外",y:s,drilldown:"海外"}]}],drilldown:{series:[h,c]}});var l=_.groupBy(i.browser,n=>n[0].split(/\d+/)[0]),a=[],v=[];for(u in l)f=0,e={name:u,id:u,data:[]},l[u].map(n=>{f+=n[1],e.data.push([n[0],n[1]])}),a.push({name:u,y:f,drilldown:u}),v.push(e);$("#browser").highcharts({chart:{type:"pie",plotBackgroundColor:null,plotBorderWidth:null,backgroundColor:"transparent",plotShadow:!1},title:{text:"浏览器统计"},boost:{useGPUTranslations:!0},credits:{enabled:!1},plotOptions:{series:{dataLabels:{enabled:!0,format:"<b>{point.name}<\/b>: {point.percentage:.2f} % - {point.y}人/次"}}},tooltip:{headerFormat:"<span>{series.name}<\/span><br>",pointFormat:'<span style="color:{point.color}">{point.name}<\/span>: <b>{point.percentage:.2f}%<\/b> - {point.y}<\/b>人/次<br/>'},series:[{name:"浏览器类型",colorByPoint:!0,data:a}],drilldown:{series:v}});$("#alldata").highcharts("StockChart",{credits:{enabled:!1},boost:{useGPUTranslations:!0},rangeSelector:{buttons:[{type:"day",count:7,text:"1周"},{type:"day",count:15,text:"半个月"},{type:"month",count:1,text:"1个月"},{type:"month",count:3,text:"3个月"},{type:"month",count:6,text:"6个月"},{type:"ytd",text:"YTD"},{type:"year",count:1,text:"1年"},{type:"all",count:1,text:"所有"}],selected:2,inputEnabled:!1},tooltip:{dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%Y-%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"},formatter:function(){try{return"时间点：<b>"+Highcharts.dateFormat("%Y-%m-%d",this.points[0].x)+'<\/b><br/><span style="color:'+Highcharts.getOptions().colors[0]+'">直接访问量：<b>'+this.points[0].y+'人/天<\/b><\/span><br/><span style="color:'+Highcharts.getOptions().colors[39]+'">独立访客量：<b>'+this.points[1].y+'人/天<\/b><\/span><br/><span style="color:'+Highcharts.getOptions().colors[35]+'">新增独立访客：<b>'+this.points[2].y+'人/天<\/b><\/span><br/><span style="color:'+Highcharts.getOptions().colors[26]+'">跳出率：<b>'+Highcharts.numberFormat(this.points[3].y,2)+"%<\/b><\/span><br/>"}catch(n){return"时间点：<b>"+Highcharts.dateFormat("%Y-%m-%d",this.points[0].x)+'<\/b><br/><span style="color:'+Highcharts.getOptions().colors[0]+'">直接访问量：<b>'+this.points[0].y+'人/天<\/b><\/span><br/><span style="color:'+Highcharts.getOptions().colors[39]+'">独立访客量：<b>'+this.points[1].y+'人/天<\/b><\/span><br/><span style="color:'+Highcharts.getOptions().colors[35]+'">新增独立访客：<b>'+this.points[2].y+"人/天<\/b><\/span><br/>"}},crosshairs:!0,shared:!0},scrollbar:{enabled:!1},title:{text:"历史访客记录走势图"},xAxis:{type:"datetime",dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:[{title:{text:"访问量"},min:0,opposite:!1},{title:{text:"跳出率（%）"},min:0,max:100,opposite:!0}],plotOptions:{series:{showInNavigator:!0,marker:{enabled:!1}}},series:[{name:"直接访问量",data:i.pv,type:"areaspline",fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]}},{name:"独立访客量",data:i.uv,type:"areaspline",fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[39]],[1,Highcharts.Color(Highcharts.getOptions().colors[39]).setOpacity(0).get("rgba")]]}},{name:"独立访客",data:i.iv,type:"areaspline",fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[35]],[1,Highcharts.Color(Highcharts.getOptions().colors[35]).setOpacity(0).get("rgba")]]}},{name:"跳出率",data:i.BounceRateAggregate,type:"areaspline",yAxis:1,fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[26]],[1,Highcharts.Color(Highcharts.getOptions().colors[26]).setOpacity(0).get("rgba")]]}}]})})};n.analysis();n.details=function(t){layer.open({type:1,zIndex:20,title:"访客浏览路径",offset:window.screen.height*.02+"px",area:document.body.clientWidth*.8+"px",content:$("#modal"),success:function(){n.request("/interview/InterviewDetails",{id:t},function(t){t.Success&&(n.viewer=t.Data.interview,n.viewdetails=t.Data.details,f.ViewDetails=new i({count:10},{filterDelay:0,dataset:t.Data.details}))})},end:function(){$("#modal").css("display","none")}})}}]);myApp.controller("searchAnalysis",["$scope","$http","NgTableParams","$timeout",function(n,t,i,r){var f,u;window.hub.disconnect();f=this;n.loading();n.query="";n.currentPage=1;t.post("/search/HotKey").then(function(t){t.data.Success?n.agg=t.data.Data:window.notie.alert({type:3,text:t.data.Message,time:4})});n.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:25,perPageOptions:[1,5,10,15,20,30,40,50],rememberPerPage:"perPageItems",onChange:function(){u&&r.cancel(u);u=r(function(){f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);u=null},100)}};n.search=function(){u&&r.cancel(u);u=r(function(){f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);u=null},1e3)};this.GetPageData=function(r,u){n.loading();t.post("/search/SearchList",{page:r,size:u,search:n.query}).then(function(t){t.data.TotalCount>0?(n.paginationConf.currentPage=r,n.paginationConf.totalItems=t.data.TotalCount,$("#interview").next("div[ng-table-pagination]").remove(),f.tableParams=new i({count:5e4},{filterDelay:0,dataset:t.data.Data})):window.notie.alert({type:3,text:t.data.Message,time:4});n.loadingDone()})};f.del=function(t){swal({title:"确认删除这条记录吗？",text:t.Title,showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消",showLoaderOnConfirm:!0,animation:!0,allowOutsideClick:!1}).then(function(){n.request("/search/delete",{id:t.Id},function(n){window.notie.alert({type:1,text:n.Message,time:4})});f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage)},function(){}).catch(swal.noop)}}]);