myApp.controller("menu",["$scope","$http","$timeout",function(n,t,i){window.hub.disconnect();n.loading();n.menu={};n.init=function(){n.request("/menu/getmenus",null,function(t){n.data=transData(t.Data,"Id","ParentId","nodes");n.collapse=!0;i(function(){n.expandAll()},0)})};var e,o,r,u,f;n.treeOptions={beforeDrop:function(n){return r=n.dest.index,n.dest.nodesScope.$parent.$modelValue&&(u=n.dest.nodesScope.$parent.$modelValue,u.Url&&u.Url!="#")?(swal("异常操作！","菜单【"+u.Name+"】是一个有链接的菜单，不能作为父级菜单","error"),!1):void 0},dropped:function(t){var s=t.dest.nodesScope,i;o=s.$id;var l=s.node?s.node.id:0,c=null,h=null;if(r>f?(h=s.$modelValue[r+1],c=s.$modelValue[r]):r<f?(h=s.$modelValue[r],c=s.$modelValue[r-1]):h=s.$modelValue[r],i=t.source.nodeScope.$modelValue,o==e){if(r==f)return;(c||h)&&(h?(i.ParentId=l,i.Sort=h.Sort-1,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})})):c&&(i.ParentId=l,i.Sort=c.Sort+1,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})})))}else u?(h=s.$modelValue[r],c=s.$modelValue[r-1],c||h?h?(i.ParentId=u.Id,i.Sort=h.Sort-1,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})})):c&&(i.ParentId=u.Id,i.Sort=c.Sort+1,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})})):(i.ParentId=u.Id,i.Sort=u.Sort*10,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})}))):(f=t.source.nodesScope.$parent.index(),r<f?(h=s.$modelValue[r+1],c=s.$modelValue[r]):(h=s.$modelValue[r],c=s.$modelValue[r-1]),h?(i.ParentId=l,i.Sort=h.Sort-1,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})})):c&&(i.ParentId=l,i.Sort=c.Sort+1,n.request("/menu/save",i,function(n){window.notie.alert({type:1,text:n.Message,time:3})}))),u=null},dragStart:function(n){e=n.dest.nodesScope.$id;f=n.dest.index}};n.findNodes=function(){};n.visible=function(t){return!(n.query&&n.query.length>0&&t.Name.indexOf(n.query)==-1)};n.menu={};n.newItem=function(){layer.open({type:1,zIndex:20,title:"修改菜单信息",area:(window.screen.width>600?600:window.screen.width)+"px",content:$("#modal"),success:function(){n.menu={}},end:function(){$("#modal").css("display","none")}});var t=n.data[n.data.length-1];n.menu.Sort=t.Sort+(t.nodes.length+1)*10;n.menu.ParentId=0};n.submenu={};n.closeAll=function(){layer.closeAll();setTimeout(function(){$("#modal").css("display","none")},500)};n.newSubItem=function(t){layer.open({type:1,zIndex:20,title:"修改菜单信息",area:(window.screen.width>600?600:window.screen.width)+"px",content:$("#modal"),success:function(){n.menu={}},end:function(){$("#modal").css("display","none")}});var i=t.$modelValue;if(n.submenu=i,i.Url&&i.Url!="#")return swal("异常操作！","菜单【"+i.Name+"】是一个有链接的菜单，不能作为父级菜单","error"),!1;n.menu.Sort=(i.Sort+i.nodes.length+1)*10;n.menu.ParentId=i.Id};n.expandAll=function(){n.collapse?n.$broadcast("angular-ui-tree:collapse-all"):n.$broadcast("angular-ui-tree:expand-all");n.collapse=!n.collapse};n.del=function(t){var i=t.$nodeScope.$modelValue,r=i.Id;swal({title:"确认删除这个菜单吗？",text:i.Name,showCancelButton:!0,showCloseButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消",showLoaderOnConfirm:!0,animation:!0,allowOutsideClick:!1}).then(function(){n.request("/menu/delete",{id:r},function(n){window.notie.alert({type:1,text:n.Message,time:4});t.remove()})},function(){}).catch(swal.noop)};n.getMenuType=function(){n.request("/menu/getmenutype",null,function(t){n.MenuType=t.Data})};n.edit=function(t){n.menu=t;layer.open({type:1,zIndex:20,title:"修改菜单信息",area:(window.screen.width>600?600:window.screen.width)+"px",content:$("#modal"),success:function(){n.menu=t},end:function(){$("#modal").css("display","none")}})};n.submit=function(t){if((t.Icon==""||t.Icon==null||t.Icon==undefined)&&(t.Icon=null),t.Id)n.request("/menu/save",t,function(t){swal(t.Message,null,"info");n.menu={};n.closeAll()});else{if(t.ParentId==0){var i=n.data[n.data.length-1];t.Sort=i.Sort+(i.nodes.length+1)*10;n.data.push(t)}else n.submenu.nodes.push(t);n.request("/menu/save",t,function(t){window.notie.alert({type:1,text:t.Message,time:3});n.menu={};n.closeAll();n.init()})}};n.upload=function(){swal({title:"请选择一张图片",input:"file",showCancelButton:!0,showCloseButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消",showLoaderOnConfirm:!0,animation:!0,inputAttributes:{accept:"image/*"}}).then(function(i){if(i){var r=new FileReader;r.onload=function(i){swal({title:"上传预览",text:"确认后将开始上传并应用设置！",imageUrl:i.target.result,showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"开始上传",cancelButtonText:"取消",showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(n,r){t.post("/upload/DecodeDataUri",{data:i.target.result}).then(function(t){var i=t.data;i.Success?n(i.Data):r(i.Message)},function(n){r("请求失败，错误码："+n.status)})})}}).then(function(t){n.menu.Icon=t}).catch(swal.noop)};r.readAsDataURL(i)}}).catch(swal.noop)};n.init();n.getMenuType()}]);